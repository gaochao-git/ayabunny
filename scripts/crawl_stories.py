#!/usr/bin/env python3
"""
儿童故事爬虫脚本

从网上爬取儿童故事并通过 API 存入技能系统

使用方法：
    cd /Users/gaochao/work/voice_chat_local_v2
    conda activate fxcjg
    python scripts/crawl_stories.py

数据源：
    - 61ertong.com (61儿童网)
    - 或者使用内置的经典故事列表
"""

import requests
from bs4 import BeautifulSoup
import time
import re
import json
from urllib.parse import urljoin

# 后端 API 地址
API_BASE = "http://127.0.0.1:6002/api/skills/storytelling/stories"

# 请求头
HEADERS = {
    "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36"
}

# 经典儿童故事列表（备用，如果爬取失败）
CLASSIC_STORIES = [
    {
        "title": "白雪公主",
        "content": """很久很久以前，有一位美丽的公主，她的皮肤像雪一样白，嘴唇像血一样红，头发像乌木一样黑，所以大家都叫她白雪公主。

白雪公主的继母是一个心肠很坏的女人。她有一面魔镜，每天都会问："魔镜魔镜告诉我，谁是世界上最美丽的女人？"

魔镜总是回答："王后，您是世界上最美丽的女人。"

但是有一天，魔镜说："王后，您很美丽，但白雪公主比您更美丽。"

王后非常生气，派猎人去杀死白雪公主。但善良的猎人不忍心，放走了白雪公主。

白雪公主逃进了森林，发现了一座小房子。房子里住着七个小矮人。小矮人们很喜欢白雪公主，让她住下来。

可是恶毒的王后发现白雪公主还活着。她变成一个老婆婆，带着一个毒苹果来找白雪公主。

白雪公主咬了一口毒苹果，就倒下了。小矮人们很伤心，把她放在水晶棺材里。

后来，一位王子经过这里，看到了美丽的白雪公主。王子深深地爱上了她，亲吻了她。奇迹发生了，白雪公主醒了过来！

王子和白雪公主结婚了，从此过上了幸福的生活。

---

**故事启示：** 善良的人总会遇到好人帮助，坏人最终会受到惩罚。"""
    },
    {
        "title": "小红帽",
        "content": """从前有个可爱的小女孩，她总是戴着一顶红色的帽子，所以大家都叫她小红帽。

一天，妈妈对小红帽说："外婆生病了，你给外婆送些点心去吧。记住，走大路，不要在森林里逗留。"

在森林里，小红帽遇到了一只大灰狼。大灰狼问："小红帽，你要去哪里呀？"

小红帽说："我要去外婆家。"

大灰狼心里打起了坏主意。它抄近路先跑到外婆家，把外婆吞进了肚子里，然后躺在床上，装成外婆的样子。

小红帽到了外婆家，觉得外婆今天看起来怪怪的。

"外婆，你的耳朵怎么这么大？""为了更好地听你说话呀。"

"外婆，你的眼睛怎么这么大？""为了更好地看你呀。"

"外婆，你的嘴巴怎么这么大？""为了把你吃掉呀！"

大灰狼跳起来，把小红帽也吞进了肚子。

这时，一个猎人路过，剪开大灰狼的肚子，救出了外婆和小红帽。

小红帽说："我以后一定听妈妈的话，再也不和陌生人说话了。"

---

**故事启示：** 小朋友不要和陌生人说话，要听爸爸妈妈的话。"""
    },
    {
        "title": "灰姑娘",
        "content": """从前有一个善良的女孩叫灰姑娘。她的妈妈去世后，爸爸娶了一个坏心肠的继母。继母带来了两个女儿，她们对灰姑娘很坏，让她做所有的家务活。

有一天，王子要举办一场盛大的舞会。灰姑娘很想去，但继母不让她去。

灰姑娘伤心地哭了起来。这时，一位仙女出现了。

"别哭，好孩子，我会帮助你的。"仙女用魔法把南瓜变成了马车，把老鼠变成了马，还给灰姑娘变出了一件美丽的裙子和一双水晶鞋。

"记住，魔法会在午夜十二点消失。"仙女叮嘱道。

灰姑娘来到舞会上，她是那天晚上最美丽的姑娘。王子和她跳了一整晚的舞。

当钟声敲响十二下时，灰姑娘急忙跑走，不小心掉了一只水晶鞋。

王子捡起水晶鞋，决定找到这只鞋的主人。他走遍全国，让每个姑娘试穿。

最后，灰姑娘穿上正好合适！王子认出了她，向她求婚。

灰姑娘和王子结婚了，从此过上了幸福的生活。

---

**故事启示：** 善良的人终会得到幸福。无论遇到什么困难，都要保持善良和希望。"""
    },
    {
        "title": "龟兔赛跑",
        "content": """从前，森林里住着一只骄傲的兔子和一只勤劳的乌龟。

有一天，兔子看见乌龟慢吞吞地走路，嘲笑道："你走得这么慢，什么时候才能到地方呀？"

乌龟不服气地说："那我们来比赛跑步吧！"

兔子哈哈大笑："好啊，让你输得心服口服！"

比赛开始了。兔子一溜烟就跑得很远很远。它回头看看，乌龟还在起点附近呢。

兔子心想："乌龟这么慢，我先睡一觉再跑也来得及。"于是它在路边的大树下躺下来睡觉了。

乌龟虽然走得慢，但它一步一步，坚持不停地向前走。它走过了兔子睡觉的地方，继续往前走。

当兔子醒来的时候，太阳已经快落山了。它赶紧往终点跑去，可是到了终点一看，乌龟早就在那里等着它了！

乌龟微笑着说："兔子先生，我赢了。"

兔子羞红了脸，低下了头。

---

**故事启示：** 骄傲使人落后，坚持不懈的努力才能成功。慢慢来，但不要停下来。"""
    },
    {
        "title": "狼来了",
        "content": """从前，山脚下住着一个放羊的孩子。每天他都要赶着羊群到山上去吃草。

有一天，他觉得很无聊，就想出了一个恶作剧。他跑到山顶大喊："狼来了！狼来了！"

山下的村民们听到喊声，都放下手中的活，拿着锄头、扁担跑上山来帮忙打狼。

可是他们上山一看，哪里有什么狼？放羊娃哈哈大笑："哈哈，你们上当了！"

村民们生气地走了。

过了几天，放羊娃又觉得无聊了，他又大喊："狼来了！狼来了！"

村民们又跑上山来，却又发现是假的。大家非常生气。

又过了几天，狼真的来了！放羊娃吓坏了，拼命喊："狼来了！狼来了！救命啊！"

可是这一次，村民们都不相信他了，没有人来帮他。

狼吃掉了好几只羊，放羊娃伤心地哭了。

---

**故事启示：** 说谎是很坏的习惯，经常说谎的人，即使说真话也没人相信了。我们要做诚实的孩子。"""
    },
    {
        "title": "乌鸦喝水",
        "content": """一只乌鸦口渴了，到处找水喝。

它飞呀飞，终于看到了一个瓶子，瓶子里有水。乌鸦高兴极了，赶紧飞过去。

可是，瓶子的口太小了，乌鸦的嘴伸不进去。瓶子里的水又太少，乌鸦怎么也喝不到。

乌鸦想把瓶子推倒，可是瓶子太重了，推不动。

怎么办呢？乌鸦看着瓶子，想啊想啊……

突然，它看到旁边有很多小石子。乌鸦眼睛一亮，想出了一个好办法！

它叼起一颗小石子，投进瓶子里。又叼起一颗，又投进去。一颗、两颗、三颗……

瓶子里的水慢慢升高了！越来越高！

终于，水升到了瓶口，乌鸦开心地喝到了水。

---

**故事启示：** 遇到困难不要放弃，要动脑筋想办法。只要肯动脑筋，总能找到解决问题的办法。"""
    },
    {
        "title": "孔融让梨",
        "content": """在很久以前，有一个叫孔融的小男孩。他很聪明，也很懂事。

孔融四岁的时候，有一天，爸爸的朋友送来一篮子梨。梨有大有小，看起来都很好吃。

爸爸让孔融把梨分给大家。孔融先拿起最大的梨，给了爷爷；又拿了一个大的，给了奶奶；然后分给爸爸妈妈和哥哥们。

最后，篮子里只剩下一个最小的梨了。孔融把这个最小的梨留给了自己。

爸爸问他："孔融，你为什么把最小的梨留给自己呢？"

孔融说："我年纪最小，应该吃最小的。大的梨应该给爷爷奶奶和哥哥们吃。"

爸爸又问："可是弟弟比你还小呀。"

孔融说："我是哥哥，应该让着弟弟。"

爸爸听了非常高兴，夸奖孔融是个懂事的好孩子。

---

**故事启示：** 要懂得谦让和分享，对长辈要尊敬，对弟弟妹妹要爱护。"""
    },
    {
        "title": "司马光砸缸",
        "content": """从前，有一个叫司马光的小男孩，他非常聪明。

有一天，司马光和小伙伴们在院子里玩捉迷藏。院子里有一口装满水的大缸。

一个小朋友为了躲藏，爬到了大缸上面。可是他一不小心，"扑通"一声掉进了大缸里！

缸里的水很深，那个小朋友在水里挣扎，眼看就要被淹没了。

其他小朋友都吓坏了，有的哭起来，有的跑去叫大人。

只有司马光没有慌张。他看到旁边有一块大石头，赶紧搬起来，使劲向大缸砸去。

"砰！"大缸破了一个大洞，水哗哗地流了出来。

掉进缸里的小朋友得救了！

大人们赶来后，都夸司马光聪明勇敢，临危不乱。

---

**故事启示：** 遇到危险不要慌张，要冷静思考，想办法解决问题。勇敢和智慧一样重要。"""
    },
    {
        "title": "卖火柴的小女孩",
        "content": """在一个寒冷的大年夜，街上下着雪。一个小女孩光着脚，手里拿着一把火柴，在街上走着。

她的口袋里一根火柴也没卖掉。她又冷又饿，不敢回家，因为爸爸会打她。

小女孩蜷缩在墙角里。她太冷了，决定点燃一根火柴暖暖手。

火柴燃起来了，小女孩仿佛看到了一个大火炉。她伸出手去烤火，可是火柴灭了，火炉不见了。

她又点燃一根火柴，看到了一只烤鹅。香喷喷的烤鹅向她走来，可是火柴又灭了。

她再点燃一根火柴，看到了美丽的圣诞树。树上挂满了礼物和蜡烛。

小女孩点燃了更多的火柴，她看到了最疼爱她的奶奶。

"奶奶，请把我带走吧！"小女孩喊道。

奶奶把小女孩抱在怀里，带着她飞向了天空，去到一个没有寒冷、没有饥饿的地方。

---

**故事启示：** 要关心身边需要帮助的人，让世界充满温暖和爱。"""
    },
    {
        "title": "皇帝的新衣",
        "content": """从前有一个爱穿漂亮衣服的皇帝。他每天都要换好几套新衣服。

有两个骗子来到城里，说他们能织出世界上最美丽的布，而且这种布有一个特点：愚蠢的人是看不见的。

皇帝很高兴，给了他们很多金子，让他们织布做衣服。

两个骗子假装日夜忙碌，其实什么也没织。大臣们去看，什么也没看见，但怕被说成愚蠢，都说布很漂亮。

皇帝也去看了，他什么也没看见，但也不敢说，怕别人说他愚蠢。他说："真是太漂亮了！"

衣服"做好"了，皇帝穿上"新衣"去游行。街上的人都夸："皇帝的新衣真漂亮！"因为大家都怕被说成愚蠢。

突然，一个小孩子喊道："他什么衣服也没穿呀！"

人们开始窃窃私语，终于都说了真话："皇帝真的什么都没穿！"

皇帝的脸红了，但他还是装作很镇定地走完了游行。

---

**故事启示：** 要诚实，不要因为怕别人说而说假话。真话有时候很简单，只是需要勇气说出来。"""
    },
    {
        "title": "青蛙王子",
        "content": """从前有一位美丽的公主，她最喜欢一个金色的球。

有一天，公主在井边玩金球，一不小心，金球掉进了深深的井里。公主伤心地哭了起来。

这时，一只青蛙从井里探出头来说："公主，我可以帮你把金球捞上来。但是你要答应我，让我做你的朋友，和你一起吃饭、一起睡觉。"

公主心想："一只青蛙，能拿我怎么样？"就答应了。

青蛙跳进井里，捞出了金球。公主拿起金球就跑回了城堡，把青蛙忘得一干二净。

第二天，青蛙来到城堡门口。公主不想理它，但国王说："你答应过的事，就一定要做到。"

公主只好让青蛙和她一起吃饭。到了晚上，青蛙还要和她一起睡觉。公主太生气了，把青蛙扔到墙上。

奇迹发生了！青蛙变成了一个英俊的王子！

原来，王子被巫婆施了魔法，只有公主才能解救他。

王子和公主结婚了，从此过上了幸福的生活。

---

**故事启示：** 答应别人的事情就要做到，要做一个守信用的人。"""
    },
    {
        "title": "睡美人",
        "content": """很久以前，国王和王后生了一个漂亮的小公主。他们邀请了全国的仙女来祝福公主。

可是有一个老仙女没有被邀请，她很生气。她来到宴会上，诅咒公主说："公主在十五岁时，会被纺锤刺伤手指而死！"

一个年轻的仙女还没有送出祝福。她虽然不能完全解除诅咒，但她说："公主不会死，只会沉睡一百年，直到有一位王子来亲吻她。"

国王下令销毁全国所有的纺锤。

公主长到十五岁那年，发现城堡里有一间从没去过的房间。房间里有一位老婆婆在纺线。公主从没见过纺锤，好奇地摸了一下，手指被刺了一下，她立刻倒下沉睡了。

整个城堡的人都跟着睡着了。城堡周围长满了荆棘。

一百年过去了，一位王子听说了睡美人的故事。他披荆斩棘，来到公主身边，亲吻了她。

公主醒了！整个城堡的人也都醒了。

王子和公主结婚了，从此过上了幸福的生活。

---

**故事启示：** 美好的事情值得等待。善良和勇敢终将战胜邪恶。"""
    },
    {
        "title": "拇指姑娘",
        "content": """从前有个善良的女人，她非常想要一个孩子。一位仙女给了她一粒种子。

女人把种子种在花盆里，长出了一朵美丽的花。花瓣打开后，里面坐着一个只有拇指那么大的小女孩。女人叫她拇指姑娘。

一天晚上，一只癞蛤蟆把拇指姑娘偷走了，想让她做儿子的新娘。小鱼儿们帮助拇指姑娘咬断了荷叶的茎，让她漂走了。

一只金龟子带走了拇指姑娘，但它的朋友们都说拇指姑娘很丑，金龟子就把她扔了。

冬天来了，拇指姑娘又冷又饿。一只田鼠收留了她。田鼠的邻居鼹鼠想娶拇指姑娘。

在鼹鼠的地道里，拇指姑娘发现了一只冻僵的燕子。她照顾燕子，燕子慢慢恢复了健康。

春天来了，燕子要飞走了。它带着拇指姑娘飞到了温暖的地方。

在那里，拇指姑娘遇到了花精王子。他们一样大小，一见钟情。

他们结婚了，从此过上了幸福的生活。

---

**故事启示：** 善良的人总会得到好的回报。帮助别人，也是在帮助自己。"""
    },
    {
        "title": "小蝌蚪找妈妈",
        "content": """春天来了，池塘里的冰融化了。青蛙妈妈在水草上产了很多卵。

过了几天，卵变成了一群小蝌蚪。小蝌蚪们长着大大的脑袋，黑黑的身子，甩着长长的尾巴，快活地在水里游来游去。

有一天，小蝌蚪们看见鸭妈妈带着小鸭子在游泳。他们想："我们的妈妈是谁呢？她在哪里呢？"

他们游到鸭妈妈身边问："鸭妈妈，您看见我们的妈妈了吗？"

鸭妈妈说："你们的妈妈有两只大眼睛，嘴巴又阔又大。你们到那边去找吧。"

小蝌蚪游呀游，看见一条大鱼。大鱼有两只大眼睛，嘴巴又阔又大。

"妈妈！妈妈！"小蝌蚪们喊道。

大鱼笑着说："我不是你们的妈妈。你们的妈妈有四条腿，到那边去找吧。"

小蝌蚪继续游，看见一只乌龟有四条腿，又看见一只大白鹅也有四条腿，但都不是他们的妈妈。

后来，小蝌蚪们长出了后腿，又长出了前腿，尾巴变短了。他们变成了小青蛙！

一只大青蛙跳过来说："孩子们，我是你们的妈妈呀！"

小青蛙们高兴极了："妈妈！妈妈！我们找到妈妈啦！"

---

**故事启示：** 小蝌蚪长大后会变成青蛙，这就是大自然的奇妙变化。"""
    },
    {
        "title": "狐假虎威",
        "content": """从前，在一座大森林里，住着一只威猛的老虎。所有的动物都怕它。

有一天，老虎在森林里转悠，抓住了一只狐狸。老虎正要把狐狸吃掉。

狐狸急中生智，对老虎说："你不能吃我！我是天帝派来管理百兽的。你要是吃了我，天帝会惩罚你的！"

老虎半信半疑地说："我不信。"

狐狸说："你不信？那你跟在我后面走，看看动物们是不是都怕我。"

老虎同意了，跟在狐狸后面走进森林。

森林里的动物们看见狐狸大摇大摆地走在前面，后面跟着一只大老虎，都吓得撒腿就跑。

老虎不知道动物们是因为怕自己才跑的，真以为它们是怕狐狸。

狐狸得意地说："你看，它们都怕我吧？"

老虎只好放了狐狸。

---

**故事启示：** 狐狸借老虎的威风吓唬别人。比喻借别人的力量来欺压人。我们不能学狐狸这样骗人。"""
    },
    {
        "title": "愚公移山",
        "content": """很久以前，有一位老人叫愚公。他家门前有两座大山，出门非常不方便。

愚公已经九十岁了，他召集全家人说："这两座大山挡住了我们的路，我们一起把它们移走吧！"

愚公的妻子说："你连一座小山都搬不动，怎么能搬走这两座大山呢？"

愚公说："我死了，还有儿子；儿子死了，还有孙子。子子孙孙是没有穷尽的。只要我们坚持下去，总有一天会把山移走的。"

于是，愚公带着子孙们开始挖山。

有个叫智叟的老头笑话愚公说："你太傻了！这么大的山，你挖到什么时候才能挖完呀？"

愚公说："我不怕。山不会再增高了，但我们会一直挖下去。"

愚公的精神感动了天帝。天帝派了两个大力神把两座山背走了。

从此，愚公家门前变成了平地。

---

**故事启示：** 只要有恒心，有毅力，坚持不懈，再大的困难也能克服。"""
    },
    {
        "title": "猴子捞月",
        "content": """在一个宁静的夜晚，一群小猴子在井边玩耍。

一只小猴子往井里一看，惊叫起来："不好了！月亮掉到井里去了！"

其他猴子都跑过来看，果然，井水里有一个又圆又亮的月亮。

"我们把月亮捞上来吧！"猴子们决定。

老猴子说："我倒挂在树上，你们一个接一个地往下吊，最下面的猴子就可以捞到月亮了。"

猴子们开始行动。一只接一只，它们挂成了一长串，一直垂到井水里。

最下面的小猴子伸手去捞月亮。可是，它的手一碰到水，月亮就碎成了好多片。

"哎呀，我把月亮弄碎了！"小猴子喊道。

大家很着急，赶紧把小猴子拉上来。

过了一会儿，井水平静了，月亮又变回了圆圆的。

这时，一只小猴子抬头看天，发现月亮好好地挂在天上呢！

"原来月亮在天上啊！井里的是月亮的影子！"猴子们这才明白过来。

---

**故事启示：** 要分清事物的真假，不要被假象所迷惑。做事之前要先想清楚。"""
    },
    {
        "title": "小马过河",
        "content": """小马长大了，妈妈让它驮着麦子去磨坊。

走着走着，一条小河挡住了去路。河水哗哗地流着，小马不知道河水有多深，能不能过去。

它看见一头老牛在河边吃草，就问："牛伯伯，这河水深不深？我能过去吗？"

老牛说："不深不深，河水才到我的小腿，你过去吧。"

小马正要下水，一只松鼠跳出来拦住它："小马，别过去！河水很深，前几天我的朋友掉进去淹死了！"

小马不知道该听谁的了。它跑回家问妈妈："妈妈，这河水到底是深还是浅呀？"

妈妈说："孩子，老牛和松鼠说的都是自己的感受。老牛个子高，所以觉得水浅；松鼠个子小，所以觉得水深。你自己去试一试，不就知道了吗？"

小马回到河边，小心翼翼地趟进河水里。河水不像老牛说的那么浅，也不像松鼠说的那么深，刚好到它的腿中间。

小马顺利地过了河，把麦子送到了磨坊。

---

**故事启示：** 别人的经验不一定适合自己。遇到问题要自己动脑筋，亲自去试一试。"""
    },
    {
        "title": "曹冲称象",
        "content": """三国时候，有人送给曹操一头大象。曹操想知道这头大象有多重。

可是大象太大了，没有那么大的秤能称它。大家想了很多办法，都不行。

曹操的小儿子曹冲才七岁，他说："我有办法！"

曹冲让人把大象牵到一条大船上。大象上船后，船往下沉了一些。曹冲让人在船帮上画一条线，标记水面的位置。

然后，把大象牵下船。再往船上装石头，装啊装啊，一直装到船沉到画线的地方为止。

曹冲说："现在把船上的石头称一称，加起来就是大象的重量了！"

大家一称，果然知道了大象有多重。

曹操高兴极了，夸奖曹冲说："我的儿子真聪明！"

---

**故事启示：** 遇到难题要多动脑筋。曹冲用石头代替大象，把大问题变成了小问题，这就是智慧。"""
    },
    {
        "title": "守株待兔",
        "content": """从前，有一个农夫在田里干活。

有一天，一只兔子从树林里跑出来，不小心撞在田边的树桩上，撞死了。

农夫捡起兔子，高兴极了："哈哈，不用干活就有兔子吃，太好了！"

从此以后，农夫不再种田了。他每天坐在树桩旁边，等着兔子来撞死。

一天过去了，没有兔子。一个星期过去了，还是没有兔子。一个月过去了，仍然没有兔子。

农夫的田地因为没人照料，长满了野草。庄稼都枯死了，颗粒无收。

而兔子呢？再也没有兔子来撞树桩了。

农夫既没等到兔子，又没有了粮食，只好饿着肚子后悔。

---

**故事启示：** 不能抱着侥幸心理，期望不劳而获。想要有收获，就要努力劳动。"""
    },
]


def sanitize_filename(title: str) -> str:
    """将标题转换为合法的文件名"""
    # 移除特殊字符，保留中文和基本字符
    filename = re.sub(r'[^\w\u4e00-\u9fff]', '_', title)
    # 移除多余的下划线
    filename = re.sub(r'_+', '_', filename).strip('_')
    return filename.lower()


def save_story_via_api(title: str, content: str, retries: int = 3) -> bool:
    """通过 API 保存故事（使用 curl 避免 Python requests 问题）"""
    import subprocess

    data = json.dumps({"title": title, "content": content}, ensure_ascii=False)

    for attempt in range(retries):
        try:
            result = subprocess.run(
                [
                    "curl", "-s", "-X", "POST", API_BASE,
                    "-H", "Content-Type: application/json",
                    "-d", data,
                    "-w", "\n%{http_code}"
                ],
                capture_output=True,
                text=True,
                timeout=30
            )

            lines = result.stdout.strip().split('\n')
            status_code = int(lines[-1]) if lines else 0

            if status_code == 200:
                print(f"  ✓ 保存成功: {title}")
                return True
            elif status_code == 409:
                print(f"  - 已存在: {title}")
                return False
            else:
                print(f"  ✗ 保存失败: {title} ({status_code})")
                if attempt < retries - 1:
                    time.sleep(1)
                    continue
                return False
        except Exception as e:
            print(f"  ✗ 错误 (尝试 {attempt + 1}/{retries}): {e}")
            if attempt < retries - 1:
                time.sleep(1)
                continue
            return False
    return False


def crawl_from_61ertong():
    """从 61儿童网 爬取故事"""
    print("\n尝试从 61儿童网 爬取故事...")

    # 童话故事列表页
    list_url = "http://www.61ertong.com/gushi/tonghua/"

    try:
        response = requests.get(list_url, headers=HEADERS, timeout=10)
        response.encoding = 'gb2312'
        soup = BeautifulSoup(response.text, 'html.parser')

        # 查找故事链接
        links = soup.select('a[href*="/gushi/tonghua/"]')
        story_urls = []

        for link in links[:30]:  # 限制数量
            href = link.get('href')
            if href and '.htm' in href:
                full_url = urljoin(list_url, href)
                if full_url not in story_urls:
                    story_urls.append(full_url)

        print(f"  找到 {len(story_urls)} 个故事链接")

        stories = []
        for url in story_urls[:20]:  # 只爬取前20个
            try:
                time.sleep(1)  # 礼貌爬取
                resp = requests.get(url, headers=HEADERS, timeout=10)
                resp.encoding = 'gb2312'
                page = BeautifulSoup(resp.text, 'html.parser')

                # 提取标题
                title_elem = page.select_one('h1') or page.select_one('.title')
                if not title_elem:
                    continue
                title = title_elem.get_text().strip()

                # 提取内容
                content_elem = page.select_one('.content') or page.select_one('#content')
                if not content_elem:
                    continue
                content = content_elem.get_text().strip()

                if title and content and len(content) > 100:
                    stories.append({"title": title, "content": content})
                    print(f"  爬取: {title}")

            except Exception as e:
                print(f"  爬取失败: {e}")
                continue

        return stories

    except Exception as e:
        print(f"  网站访问失败: {e}")
        return []


def use_classic_stories():
    """使用内置的经典故事"""
    print("\n使用内置的经典儿童故事...")
    return CLASSIC_STORIES


def main():
    print("=" * 50)
    print("儿童故事爬虫")
    print("=" * 50)

    # 检查 API 是否可用
    try:
        response = requests.get(API_BASE, timeout=5)
        print(f"API 状态: OK ({response.status_code})")
    except:
        print("API 不可用，请先启动后端服务 (python main.py)")
        return

    # 尝试爬取，失败则使用内置故事
    stories = crawl_from_61ertong()

    if len(stories) < 10:
        print("\n网站爬取数量不足，使用内置故事补充...")
        stories = use_classic_stories()

    # 保存故事
    print(f"\n开始保存 {len(stories)} 个故事...")
    success_count = 0

    for story in stories:
        if save_story_via_api(story["title"], story["content"]):
            success_count += 1

    print("\n" + "=" * 50)
    print(f"完成！成功保存 {success_count} 个故事")
    print("=" * 50)


if __name__ == "__main__":
    main()
